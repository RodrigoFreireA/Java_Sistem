import { Component, OnDestroy, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';
import { Router } from '@angular/router';
import { ProductService } from '../../product.service';
import { AuthService } from '../../auth.service';

const FALLBACK_IMAGE = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="250"><rect width="100%" height="100%" fill="%23121a2a"/><text x="50%" y="50%" fill="%23ffffff" font-family="Arial" font-size="18" dominant-baseline="middle" text-anchor="middle">Imagem%20indisponivel</text></svg>';

@Component({
  selector: 'app-home',
  standalone: true,
  imports: [CommonModule, FormsModule],
  templateUrl: './home.html',
  styleUrl: './home.scss',
})
export class Home implements OnInit, OnDestroy {
  products: any[] = [];
  cards: any[] = [];
  filteredCards: any[] = [];
  loadError = '';

  categories: { name: string; count: number; active: boolean }[] = [
    { name: 'Todos os Brinquedos', count: 0, active: true }
  ];

  slides = [
    {
      image: 'images/carousel1.png',
      badge: 'Aluguel de brinquedos',
      title1: 'Diversao garantida',
      title2: 'para sua festa!',
      subtitle: 'Brinquedos inflaveis e camas elasticas com qualidade premium.'
    },
    {
      image: 'images/carousel2.png',
      badge: 'Seguranca e alegria',
      title1: 'Camas elasticas',
      title2: 'para todas as idades',
      subtitle: 'Montagem rapida e equipe especializada.'
    },
    {
      image: 'images/carousel3.png',
      badge: 'Festas inesqueciveis',
      title1: 'Castelos e tobogas',
      title2: 'coloridos e seguros',
      subtitle: 'Escolha o tamanho ideal para seu espaco.'
    }
  ];

  currentSlide = 0;
  private slideTimer: any;

  constructor(
    private productService: ProductService,
    private authService: AuthService,
    private router: Router
  ) {}

  ngOnInit(): void {
    this.loadProducts();
    this.startSlider();
  }

  ngOnDestroy(): void {
    if (this.slideTimer) {
      clearInterval(this.slideTimer);
    }
  }

  loadProducts() {
    this.loadError = '';
    this.productService.listAll().subscribe({
      next: (data) => {
        this.products = data || [];
        this.cards = this.buildCards(this.products);
        this.categories = this.buildCategories(this.products);
        this.filteredCards = this.cards;
      },
      error: (err) => {
        this.loadError = err?.error?.message || 'Erro ao carregar catalogo';
        this.cards = [];
        this.filteredCards = [];
      }
    });
  }

  selectProduct(p: any) {
    const productId = p?.productId || p?.id;
    if (!productId) {
      return;
    }
    if (!this.authService.isLoggedIn()) {
      this.router.navigateByUrl('/login');
      return;
    }
    this.router.navigate(['/agendar', productId]);
  }

  nextSlide() {
    this.currentSlide = (this.currentSlide + 1) % this.slides.length;
  }

  prevSlide() {
    this.currentSlide = (this.currentSlide - 1 + this.slides.length) % this.slides.length;
  }

  goToSlide(i: number) {
    this.currentSlide = i;
  }

  private startSlider() {
    this.slideTimer = setInterval(() => this.nextSlide(), 5000);
  }

  private buildCards(products: any[]): any[] {
    return (products || []).slice(0, 9).map((p) => ({
      name: p.name,
      category: p.category,
      productId: p.id,
      image: this.primaryImage(p),
      price: p.salePrice ?? 0,
      ageRange: p.ageRange || '',
      size: p.size || ''
    }));
  }

  private primaryImage(p: any): string {
    if (p?.imageUrl) return p.imageUrl;
    const gallery = this.parseGallery(p?.galleryUrls);
    if (gallery.length > 0) return gallery[0];
    return FALLBACK_IMAGE;
  }

  private parseGallery(raw: any): string[] {
    if (!raw) return [];
    try {
      const arr = JSON.parse(raw);
      if (Array.isArray(arr)) {
        return arr.map((v: any) => String(v)).filter((v) => !!v);
      }
    } catch {}
    // fallback: comma-separated
    return String(raw)
      .split(',')
      .map((s) => s.trim())
      .filter(Boolean);
  }

  private buildCategories(products: any[]) {
    const counts: Record<string, number> = {};
    (products || []).forEach(p => {
      const cat = (p.category || 'Outros').trim();
      counts[cat] = (counts[cat] || 0) + 1;
    });
    const list = Object.keys(counts).map(name => ({ name, count: counts[name], active: false }));
    const allCount = list.reduce((sum, c) => sum + c.count, 0);
    return [{ name: 'Todos os Brinquedos', count: allCount, active: true }, ...list];
  }

  filterByCategory(catName: string) {
    this.categories = this.categories.map(c => ({ ...c, active: c.name === catName }));
    if (catName === 'Todos os Brinquedos') {
      this.filteredCards = this.cards;
    } else {
      this.filteredCards = this.cards.filter(c => (c.category || '').toLowerCase().includes(catName.toLowerCase()));
    }
  }
}
